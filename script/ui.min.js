"use strict";function e(e){return JSON.parse(e.value)}function t(e,t){e.value=r.formatJson(t)}function n(t,n,o,a,u){r.asyncFormSubmit(n,function(){return new Promise(function(n,r){try{var s=c.Global.getPort(t),d=c.Global.validatePort(s);if(d)r(d);else try{var p=new i.Request(i.Method.POST,"http://localhost:"+s+"/"),h=void 0;if("constraints"===a){var f=e(o);f.action=a,h=JSON.stringify(f)}else h=JSON.stringify({action:a});p.setData({json:h}),p.execute(function(e){0!==e.status?l.renderResponse(u,s,e.status,e.text):r("JADE was not activated, or the provided port number was incorrect.")})}catch(e){if(!(e instanceof SyntaxError))throw e;r("Input was not valid JSON.\n\n"+e.message)}}catch(e){r("Unhandled exception: "+e.message)}})},function(e){alert("Error: "+e)})}var r,o=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();!function(e){function t(e,n,r){void 0===r&&(r=!0);for(var o=[],i=3;i<arguments.length;i++)o[i-3]=arguments[i];var u=!1;if(r&&n.open&&(u=n.open(e)),!u){var c=0===o.length;a.forEach(e.childNodes,function(e){(c||o.indexOf(e.nodeType)>=0)&&t.apply(void 0,[e,n,!0].concat(o))})}r&&n.close&&n.close(e)}function n(e){return JSON.stringify(e,void 0,"\t")}e.domIterate=t,e.hasParentWithAttribute=function(e,t){for(var n=!1;!n&&null!==e.parentElement;)(e=e.parentElement).hasAttribute(t)&&(n=!0);return n},e.assertNever=function(e){throw new Error("Value should never be possible.")},e.formatJson=n,e.expandJson=function(e){return n(JSON.parse(e))};var r;e.query=function(){if(void 0===r){var e=location.search.substr(1).split("&");r={},e.forEach(function(e){var t=e.split("=",2);r[decodeURIComponent(t[0])]=decodeURIComponent(t[1])})}return r},e.asyncFormSubmit=function(e,t,n){e.onsubmit=function(r){return t&&t.call(e,r).then(function(e){return location.href=e}).catch(function(e){void 0!==n&&n(e)}),r.returnValue=!1,!1}},e.regexEscape=function(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},e.dictionaryNotEmpty=function(e){return Object.keys(e).length>0},e.dictionaryForEach=function(e,t){for(var n in e)e.hasOwnProperty(n)&&t(e[n],n,e)},function(e){e.makeBound=function(e,t){return void 0===t&&(t=!1),{value:e,inclusive:t}},e.makeRange=function(e,t){return{low:e,high:t}}}(e.Comparison||(e.Comparison={})),function(e){e.fill=function(e,t){for(var n=[],r=0;r<t;r++)n.push(e);return n}}(e.Array||(e.Array={}));var i=function(){function e(){}return e.prototype.next=function(e,t){return void 0===e&&(e=0),void 0===t&&(t=1),this.nextImp(e,t)},e.prototype.nextInt=function(e,t){return Math.floor(this.nextImp(e,t))},e.Standard=new(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t.prototype.nextImp=function(e,t){return Math.random()*(t-e)+e},t}(e)),e}();e.Random=i;var u=function(e){function t(t){var n=e.call(this)||this;return n.updateSeed(t),n}return o(t,e),t.prototype.updateSeed=function(e){this.seed=e},t.prototype.getSeed=function(){return this.seed},t}(i);e.SeededRandom=u}(r||(r={}));var a;!function(e){function t(e){return Array.isArray(e)||"number"==typeof e.length}function n(e){return o(e)}function r(e,t,n){return Array.prototype.map.call(e,t,n)}function o(e,t,n){return Array.prototype.slice.call(e,t,n)}e.isArrayLike=t,e.toArray=n,e.cast=function(e){return e},e.every=function(e,t,n){return Array.prototype.every.call(e,t,n)},e.some=function(e,t,n){return Array.prototype.some.call(e,t,n)},e.forEach=function(e,t,n){return Array.prototype.forEach.call(e,t,n)},e.reduce=function(e,t,n){return Array.prototype.reduce.call(e,t,n)},e.reduceRight=function(e,t,n){return Array.prototype.reduceRight.call(e,t,n)},e.map=r,e.filter=function(e,t,n){return Array.prototype.filter.call(e,t,n)},e.concat=function(e){for(var o=[],a=1;a<arguments.length;a++)o[a-1]=arguments[a];return Array.prototype.concat.apply(n(e),r(o,function(e){return t(e)?n(e):e}))},e.indexOf=function(e,t,n){return Array.prototype.indexOf.call(e,t,n)},e.lastIndexOf=function(e,t,n){return Array.prototype.lastIndexOf.call(e,t,n)},e.join=function(e,t){return Array.prototype.join.call(e,t)},e.reverse=function(e){return Array.prototype.reverse.call(n(e))},e.slice=o,e.sort=function(e,t){return Array.prototype.sort.call(n(e),t)},e.toString=function(e){return Array.prototype.toString.call(e)},e.toLocaleString=function(e){return Array.prototype.toLocaleString.call(e)}}(a||(a={}));var i;!function(e){function t(e){return void 0===e?{error:!0,status:0,text:"",type:"text/plain"}:{error:e.status>=400||0===e.status,status:e.status,text:e.responseText,type:e.responseType,xml:null!==e.responseXML?e.responseXML:void 0,json:"application/json"===e.responseType?JSON.parse(e.responseText):void 0}}var n;!function(e){e.OPTIONS="OPTIONS",e.GET="GET",e.HEAD="HEAD",e.POST="POST",e.PUT="PUT",e.DELETE="DELETE",e.TRACE="TRACE",e.CONNECT="CONNECT"}(n=e.Method||(e.Method={}));var o;!function(e){e.ACCEPT="Accept",e.ACCEPT_LANGUAGE="Accept-Language",e.AUTHORIZATION="Authorization",e.CACHE_CONTROL="Cache-Control",e.CONTENT_TYPE="Content-Type",e.FROM="From",e.IF_MATCH="If-Match",e.IF_MODIFIED_SINCE="If-Modified-Since",e.IF_NONE_MATCH="If-None-Match",e.IF_RANGE="If-Range",e.IF_UNMOFIFIED_SINCE="If-Unmodified-Since",e.MAX_FORWARDS="Max-Forwards",e.PRAGMA="Pragma",e.RANGE="Range",e.WARNING="Warning"}(o=e.Header||(e.Header={})),e.responseIsSuccess=function(e){return!e.error&&void 0!==e.text};var a=[],i=0;setInterval(function(){for(;a.length>0&&i<16;)!function(){i++;var e=a.shift();e.request.execute(function(t){i--,e.callback(t)},e.mime)}()},16);var u=function(){function e(e,t){this.headers={},this.data={},this.method=e,this.url=t}return e.prototype.encodeData=function(e){var t="string"==typeof e;e=t?e:"";var n="";return t&&(n+=e.indexOf("?")>=0?"&":"?"),r.dictionaryForEach(this.data,function(e,t){n+=encodeURIComponent(t),n+="=",n+=encodeURIComponent(e),n+="&"}),n=n.substr(0,n.length-1),e+=n},e.prototype.getMethod=function(){return this.method},e.prototype.getUrl=function(){return this.url},e.prototype.getData=function(){return this.data},e.prototype.setData=function(e){this.data=e},e.prototype.hasHeader=function(e){return this.headers.hasOwnProperty(e)},e.prototype.getHeader=function(e){return this.hasHeader(e)?this.headers[e]:void 0},e.prototype.setHeader=function(e,t){this.headers[e]=t},e.prototype.unsetHeader=function(e){this.hasHeader(e)&&delete this.headers[e]},e.prototype.queue=function(e,t){a.push({request:this,callback:e,mime:t})},e.prototype.execute=function(e,a){var i="string"==typeof a,u=this.method===n.POST,c=r.dictionaryNotEmpty(this.data),l=this.url;c&&!u&&(l=this.encodeData(l));var s=new XMLHttpRequest;s.open(this.method,l,!0),u&&s.setRequestHeader(o.CONTENT_TYPE,"application/x-www-form-urlencoded"),r.dictionaryForEach(this.headers,function(e,t){s.setRequestHeader(t,e)}),s.onreadystatechange=function(){4===s.readyState&&e(t(s))},s.onabort=function(){e(t())},i&&s.overrideMimeType(a),c&&u?s.send(this.encodeData()):s.send()},e}();e.Request=u}(i||(i={}));var u;!function(e){function t(e){var t=e.source.parentElement;a.reduce(a.cast(t.children),function(e,t){return t.hasAttribute("data-template-clone")&&e.push(t),e},[]).forEach(function(e){return t.removeChild(e)})}function n(e,t){return e.replace(t.regex,t.replacement)}function o(e){var t=[];return r.dictionaryForEach(e,function(e,n){c.test(n)?t.push({regex:new RegExp("%"+r.regexEscape(n)+"%","gi"),replacement:e}):console.error('Template arg key "'+n+'" is invalid: failed regex test '+c.source)}),t}function i(e,t){return t.reduce(function(e,t){return n(e,t)},e)}function u(e,t,n){console.log(e);var u=e.source.cloneNode(!0);u.style.display=e.display,u.setAttribute("data-template-clone","");var c=e.source.parentElement,l=o(t),s=null;return r.domIterate(u,{open:function(e){switch(e.nodeType){case Node.ELEMENT_NODE:var t=e;if(a.forEach(t.attributes,function(e){e.value=i(e.value,l)}),null===s&&t.hasAttribute("data-template")&&(s=e),null===s){if(t.hasAttribute("data-template-style")){var r=t.getAttribute("style");r=r||"",r+=t.getAttribute("data-template-style"),t.setAttribute("style",r),t.removeAttribute("data-template-style")}if(void 0!==n&&t.hasAttribute("data-template-callback")){var o=t.getAttribute("data-template-callback");t.removeAttribute("data-template-callback"),n(o,t,u,c)}}break;case Node.TEXT_NODE:e.textContent=i(e.textContent,l)}return!1},close:function(e){e===s&&(s=null)}},!0,Node.ELEMENT_NODE,Node.TEXT_NODE),c.appendChild(u),u}e.killTemplate=t;var c=/^[a-z0-9 \-_]+$/i;e.pushTemplate=u;var l=function(){function e(e,t){void 0===t&&(t=!1);var n;if(t&&e.hasAttribute("data-template"))n=[e];else{var o=e.querySelectorAll("[data-template]");n=a.filter(o,function(e){return!r.hasParentWithAttribute(e,"data-template")})}this.templates=n.reduce(function(e,t){var n=t.getAttribute("data-template");return e.hasOwnProperty(n)?console.error('Templater: Duplicate template ID "'+n+'".'):(t.removeAttribute("data-template"),e[n]={source:t,display:t.style.display},t.style.display="none"),e},{})}return e.prototype.getCount=function(){return this.getIds().length},e.prototype.getIds=function(){return Object.keys(this.templates)},e.prototype.getTemplate=function(e){return this.templates[e]},e.prototype.killTemplate=function(e){var n=this.getTemplate(e);void 0!==n&&t(n)},e.prototype.pushTemplate=function(e,t,n){var r,o=this.getTemplate(e);return void 0!==o&&(r=u(o,t,n)),r},e}();e.Templater=l}(u||(u={}));var c;!function(r){!function(t){function r(e,t,n){void 0!==e?(t.value=(Math.round(100*e)/100).toString(),n.checked=!1):(t.value="",n.checked=!0),t.disabled=n.checked}function a(t,n,a){if(t.inputJson.checked)t.formJson.style.display="",t.formFields.style.display="none";else{t.formJson.style.display="none",t.formFields.style.display="";var i=e(a);r(i.maxGridLoad,n.gridLoad,n.gridLoadNoChange),r(i.currentCharge,n.currentCharge,n.currentChargeNoChange),r(i.chargeCapacity,n.maxCharge,n.maxChargeNoChange),r(i.chargePerHour,n.chargeRate,n.chargeRateNoChange),r(i.chargeDrainPerHour,n.chargeDrain,n.chargeDrainNoChange),u.killTemplate(n.utTemplate);var c=void 0===i.unavailableTimes;c||i.unavailableTimes.forEach(function(e){return o.pushUtTemplate(n.utTemplate,e,a)}),n.utNoChange.checked=c,n.utLowValue.disabled=c,n.utLowInclusive.disabled=c,n.utHighValue.disabled=c,n.utHighInclusive.disabled=c,n.utAddButton.disabled=c,n.utAddButton.disabled=c}}t.getPort=function(e){return parseInt(e.inputPort.value)},t.validatePort=function(e){var t=void 0;return isNaN(e)?t="Port number is not a number.":e%1!=0?t="Port number must be an integer.":(e<8080||e>28080)&&(t="Port number must be between 8080 and 28080, inclusive."),t},t.setupListeners=function(e,t,r,o){e.inputJson.addEventListener("change",function(){return a(e,t,r)}),e.inputFields.addEventListener("change",function(){return a(e,t,r)}),n(e,e.form,r,"constraints",o)},t.switchDisplayedForm=a}(r.Global||(r.Global={})),(r.Json||(r.Json={})).setupListeners=function(e,t,r,o){n(e,t.form,r,"constraints",o)};var o;!function(r){function o(e,t){var n=parseFloat(e.value);isNaN(n)||!isFinite(n)?console.error(e.id+" not a number."):t(n)}function a(n,r,a){o(n,function(n){var o=e(a);o[r]=n,t(a,o)})}function i(n,r,o,i){n.addEventListener("change",function(){o.checked||a(n,r,i)}),o.addEventListener("change",function(){if(n.disabled=o.checked,o.checked){var u=e(i);delete u[r],t(i,u)}else a(n,r,i)})}function c(e){var t=e.toString();return 1===t.length&&(t="0"+t),t+":00"}function l(e,t){var n=-1;return e.some(function(e,r){var o=e.lowerBound.pivot===t.lowerBound.pivot&&e.lowerBound.inclusive==t.lowerBound.inclusive&&e.upperBound.pivot===t.upperBound.pivot&&e.upperBound.inclusive===t.upperBound.inclusive;return o&&(n=r),o}),n}function s(n,r,o){u.pushTemplate(n,{LOW:r.lowerBound.pivot,LOW_BRACKET:r.lowerBound.inclusive?"[":"(",HIGH:r.upperBound.pivot,HIGH_BRACKET:r.upperBound.inclusive?"]":")"},function(n,a,i,u){"remove-btn"===n&&a.addEventListener("click",function(){var n=e(o),a=n.unavailableTimes;a.splice(l(a,r),1),t(o,n),u.removeChild(i)})})}function d(n,r){n.utLowValue.disabled=n.utNoChange.checked,n.utLowInclusive.disabled=n.utNoChange.checked,n.utHighValue.disabled=n.utNoChange.checked,n.utHighInclusive.disabled=n.utNoChange.checked,n.utAddButton.disabled=n.utNoChange.checked;var o=e(r);n.utNoChange.checked?(u.killTemplate(n.utTemplate),delete o.unavailableTimes,t(r,o)):(o.unavailableTimes=[],t(r,o))}r.pushUtTemplate=s,r.setupListeners=function(r,a,u,l){i(a.gridLoad,"maxGridLoad",a.gridLoadNoChange,u),i(a.currentCharge,"currentCharge",a.currentChargeNoChange,u),i(a.maxCharge,"chargeCapacity",a.maxChargeNoChange,u),i(a.chargeRate,"chargePerHour",a.chargeRateNoChange,u),i(a.chargeDrain,"chargeDrainPerHour",a.chargeDrainNoChange,u),a.utNoChange.addEventListener("change",function(){return d(a,u)}),a.utAddButton.addEventListener("click",function(){a.utNoChange.checked?alert("Error: Cannot add an unavailable time range when the Do Not Change checkbox is checked."):o(a.utLowValue,function(n){return o(a.utHighValue,function(r){var o={lowerBound:{pivot:c(n),inclusive:a.utLowInclusive.checked},upperBound:{pivot:c(r),inclusive:a.utHighInclusive.checked}},i=e(u);i.unavailableTimes.push(o),t(u,i),s(a.utTemplate,o,u)})})}),n(r,a.form,u,"constraints",l)}}(o=r.Fields||(r.Fields={}))}(c||(c={}));var l;!function(e){function t(e){return e.hasOwnProperty("error")}function n(e,t){var n=parseInt(e.pivot.substr(0,2));return e.inclusive||(n+=t),n}function o(e,t){var o=r.Array.fill(!1,t);return e.forEach(function(e){var r=n(e.lowerBound,1),a=n(e.upperBound,-1);if(a<r){for(i=r;i<t;i++)o[i]=!0;for(i=0;i<a;i++)o[i]=!0}else for(var i=r;i<=a;i++)o[i]=!0}),o}function a(e){e.switchModeVis.checked?(e.visSection.style.display=null,e.raw.style.display="none"):(e.visSection.style.display="none",e.raw.style.display=null)}e.renderResponse=function(e,n,a,i){u.killTemplate(e.timetableTemplate);var c=JSON.parse(i);if(e.raw.textContent=r.formatJson(i),e.car.textContent=n.toString(),e.status.textContent=a.toString(),t(c))e.errorHead.style.display=null,e.error.style.display=null,e.timetableContainer.style.display="none",e.error.textContent=c.error;else{e.errorHead.style.display="none",e.error.style.display="none",e.timetableContainer.style.display=null;var l={},s={};c.result.forEach(function(t){var n=t.id.toString();if(!l.hasOwnProperty(n)){var r=u.pushTemplate(e.timetableTemplate,{CAR:n});l[n]=new u.Templater(r),s[n]=[]}s[n].push(t.range)}),Object.keys(l).forEach(function(t){o(s[t],e.timetableSize).map(function(n,r){l[t].pushTemplate(e.timetableSubTemplateId,{CLASS:n?"tt-range":""})})})}e.inContainer.style.display="none",e.outContainer.style.display=null},e.setupListeners=function(e){e.inContainer.style.display=null,e.outContainer.style.display="none",r.asyncFormSubmit(e.switchForm),e.switchModeVis.addEventListener("change",function(){return a(e)}),e.switchModeRaw.addEventListener("change",function(){return a(e)}),a(e),e.backBtn.addEventListener("click",function(){e.inContainer.style.display=null,e.outContainer.style.display="none"})}}(l||(l={})),window.addEventListener("DOMContentLoaded",function(){for(var e=new u.Templater(document.body),t={form:document.getElementById("form-json"),text:document.getElementById("input-json")},r={form:document.getElementById("form-fields"),gridLoad:document.getElementById("input-grid-load"),gridLoadNoChange:document.getElementById("input-grid-load-nc"),currentCharge:document.getElementById("input-current-charge"),currentChargeNoChange:document.getElementById("input-current-charge-nc"),maxCharge:document.getElementById("input-charge-capacity"),maxChargeNoChange:document.getElementById("input-charge-capacity-nc"),chargeRate:document.getElementById("input-charge-rate"),chargeRateNoChange:document.getElementById("input-charge-rate-nc"),chargeDrain:document.getElementById("input-charge-drain"),chargeDrainNoChange:document.getElementById("input-charge-drain-nc"),utLowValue:document.getElementById("input-ut-low"),utLowInclusive:document.getElementById("input-ut-low-inc"),utHighValue:document.getElementById("input-ut-high"),utHighInclusive:document.getElementById("input-ut-high-inc"),utAddButton:document.getElementById("input-ut-add"),utNoChange:document.getElementById("input-ut-nc"),utTemplate:e.getTemplate("ut")},o={form:document.getElementById("form-global"),inputJson:document.getElementById("mode-json"),inputFields:document.getElementById("mode-fields"),inputPort:document.getElementById("port"),formJson:t.form,formFields:r.form},a=document.getElementById("form-force"),i={inContainer:document.getElementById("sec-input"),outContainer:document.getElementById("sec-output"),visSection:document.getElementById("out-vis-sec"),switchForm:document.getElementById("out-switch"),switchModeVis:document.getElementById("out-vis"),switchModeRaw:document.getElementById("out-raw"),backBtn:document.getElementById("return-to-input"),raw:document.getElementById("out-var-raw"),car:document.getElementById("out-var-car"),status:document.getElementById("out-var-status"),errorHead:document.getElementById("out-var-error-head"),error:document.getElementById("out-var-error"),timetableContainer:document.getElementById("out-var-tt"),timetableTemplate:e.getTemplate("tt-data-wrap"),timetableSubTemplateId:"tt-data-hours",timetableSize:24},s=0;s<i.timetableSize;s++)e.pushTemplate("tt-hours",{N:s.toString()});c.Global.setupListeners(o,r,t.text,i),c.Json.setupListeners(o,t,t.text,i),c.Fields.setupListeners(o,r,t.text,i),n(o,a,t.text,"negotiate",i),c.Global.switchDisplayedForm(o,r,t.text),l.setupListeners(i)});