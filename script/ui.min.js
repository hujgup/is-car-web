"use strict";function e(e){return JSON.parse(e.value)}function t(e,t,n){var r="string"==typeof t?a.expandJson(t):a.formatJson(t);null!==n.currentCid&&(n.jsonData[n.currentCid]=r),e.value=r}function n(e,n){t(e,null!==n.currentCid&&n.jsonData.hasOwnProperty(n.currentCid)?n.jsonData[n.currentCid]:n.defaultJson,n)}function r(e,t){u.forEach(e,function(e){"function"==typeof e?r(e(),t):e.disabled=t})}function o(t,n,o,i,u){a.asyncFormSubmit(n,function(){return new Promise(function(n,a){try{var s=l.Global.getPort(t),p=l.Global.validatePort(s);if(p)a(p);else try{r(t.mutatorButtons,!0);var h=new c.Request(c.Method.POST,"http://localhost:"+s+"/"),m=void 0;if("constraints"===i){var f=e(o);f.action=i,m=JSON.stringify(f)}else m=JSON.stringify({action:i});h.setData({json:m}),h.execute(function(e){r(t.mutatorButtons,!1),0!==e.status?d.renderResponse(u,s,e.status,e.text):a("JADE was not activated, or the provided port number was incorrect.")})}catch(e){if(!(e instanceof SyntaxError))throw e;a("Input was not valid JSON.\n\n"+e.message)}}catch(e){a("Unhandled exception: "+e.message)}})},function(e){alert("Error: "+e)})}var a,i=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();!function(e){function t(e,n,r){void 0===r&&(r=!0);for(var o=[],a=3;a<arguments.length;a++)o[a-3]=arguments[a];var i=!1;if(r&&n.open&&(i=n.open(e)),!i){var c=0===o.length;u.forEach(e.childNodes,function(e){(c||o.indexOf(e.nodeType)>=0)&&t.apply(void 0,[e,n,!0].concat(o))})}r&&n.close&&n.close(e)}function n(e){return JSON.stringify(e,void 0,"\t")}e.domIterate=t,e.hasParentWithAttribute=function(e,t){for(var n=!1;!n&&null!==e.parentElement;)(e=e.parentElement).hasAttribute(t)&&(n=!0);return n},e.assertNever=function(e){throw new Error("Value should never be possible.")},e.formatJson=n,e.expandJson=function(e){return n(JSON.parse(e))};var r;e.query=function(){if(void 0===r){var e=location.search.substr(1).split("&");r={},e.forEach(function(e){var t=e.split("=",2);r[decodeURIComponent(t[0])]=decodeURIComponent(t[1])})}return r},e.asyncFormSubmit=function(e,t,n){e.onsubmit=function(r){return t&&t.call(e,r).then(function(e){return location.href=e}).catch(function(e){void 0!==n&&n(e)}),r.returnValue=!1,!1}},e.regexEscape=function(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},e.dictionaryNotEmpty=function(e){return Object.keys(e).length>0},e.dictionaryForEach=function(e,t){for(var n in e)e.hasOwnProperty(n)&&t(e[n],n,e)},function(e){e.makeBound=function(e,t){return void 0===t&&(t=!1),{value:e,inclusive:t}},e.makeRange=function(e,t){return{low:e,high:t}}}(e.Comparison||(e.Comparison={})),function(e){e.fill=function(e,t){for(var n=[],r=0;r<t;r++)n.push(e);return n}}(e.Array||(e.Array={}));var o=function(){function e(){}return e.prototype.next=function(e,t){return void 0===e&&(e=0),void 0===t&&(t=1),this.nextImp(e,t)},e.prototype.nextInt=function(e,t){return Math.floor(this.nextImp(e,t))},e.Standard=new(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype.nextImp=function(e,t){return Math.random()*(t-e)+e},t}(e)),e}();e.Random=o;var a=function(e){function t(t){var n=e.call(this)||this;return n.updateSeed(t),n}return i(t,e),t.prototype.updateSeed=function(e){this.seed=e},t.prototype.getSeed=function(){return this.seed},t}(o);e.SeededRandom=a}(a||(a={}));var u;!function(e){function t(e){return Array.isArray(e)||"number"==typeof e.length}function n(e){return o(e)}function r(e,t,n){return Array.prototype.map.call(e,t,n)}function o(e,t,n){return Array.prototype.slice.call(e,t,n)}e.isArrayLike=t,e.toArray=n,e.cast=function(e){return e},e.every=function(e,t,n){return Array.prototype.every.call(e,t,n)},e.some=function(e,t,n){return Array.prototype.some.call(e,t,n)},e.forEach=function(e,t,n){return Array.prototype.forEach.call(e,t,n)},e.reduce=function(e,t,n){return Array.prototype.reduce.call(e,t,n)},e.reduceRight=function(e,t,n){return Array.prototype.reduceRight.call(e,t,n)},e.map=r,e.filter=function(e,t,n){return Array.prototype.filter.call(e,t,n)},e.concat=function(e){for(var o=[],a=1;a<arguments.length;a++)o[a-1]=arguments[a];return Array.prototype.concat.apply(n(e),r(o,function(e){return t(e)?n(e):e}))},e.indexOf=function(e,t,n){return Array.prototype.indexOf.call(e,t,n)},e.lastIndexOf=function(e,t,n){return Array.prototype.lastIndexOf.call(e,t,n)},e.join=function(e,t){return Array.prototype.join.call(e,t)},e.reverse=function(e){return Array.prototype.reverse.call(n(e))},e.slice=o,e.sort=function(e,t){return Array.prototype.sort.call(n(e),t)},e.toString=function(e){return Array.prototype.toString.call(e)},e.toLocaleString=function(e){return Array.prototype.toLocaleString.call(e)}}(u||(u={}));var c;!function(e){function t(e){return void 0===e?{error:!0,status:0,text:"",type:"text/plain"}:{error:e.status>=400||0===e.status,status:e.status,text:e.responseText,type:e.responseType,xml:null!==e.responseXML?e.responseXML:void 0,json:"application/json"===e.responseType?JSON.parse(e.responseText):void 0}}var n;!function(e){e.OPTIONS="OPTIONS",e.GET="GET",e.HEAD="HEAD",e.POST="POST",e.PUT="PUT",e.DELETE="DELETE",e.TRACE="TRACE",e.CONNECT="CONNECT"}(n=e.Method||(e.Method={}));var r;!function(e){e.ACCEPT="Accept",e.ACCEPT_LANGUAGE="Accept-Language",e.AUTHORIZATION="Authorization",e.CACHE_CONTROL="Cache-Control",e.CONTENT_TYPE="Content-Type",e.FROM="From",e.IF_MATCH="If-Match",e.IF_MODIFIED_SINCE="If-Modified-Since",e.IF_NONE_MATCH="If-None-Match",e.IF_RANGE="If-Range",e.IF_UNMOFIFIED_SINCE="If-Unmodified-Since",e.MAX_FORWARDS="Max-Forwards",e.PRAGMA="Pragma",e.RANGE="Range",e.WARNING="Warning"}(r=e.Header||(e.Header={})),e.responseIsSuccess=function(e){return!e.error&&void 0!==e.text};var o=[],i=0;setInterval(function(){for(;o.length>0&&i<16;)!function(){i++;var e=o.shift();e.request.execute(function(t){i--,e.callback(t)},e.mime)}()},16);var u=function(){function e(e,t){this.headers={},this.data={},this.method=e,this.url=t}return e.prototype.encodeData=function(e){var t="string"==typeof e;e=t?e:"";var n="";return t&&(n+=e.indexOf("?")>=0?"&":"?"),a.dictionaryForEach(this.data,function(e,t){n+=encodeURIComponent(t),n+="=",n+=encodeURIComponent(e),n+="&"}),n=n.substr(0,n.length-1),e+=n},e.prototype.getMethod=function(){return this.method},e.prototype.getUrl=function(){return this.url},e.prototype.getData=function(){return this.data},e.prototype.setData=function(e){this.data=e},e.prototype.hasHeader=function(e){return this.headers.hasOwnProperty(e)},e.prototype.getHeader=function(e){return this.hasHeader(e)?this.headers[e]:void 0},e.prototype.setHeader=function(e,t){this.headers[e]=t},e.prototype.unsetHeader=function(e){this.hasHeader(e)&&delete this.headers[e]},e.prototype.queue=function(e,t){o.push({request:this,callback:e,mime:t})},e.prototype.execute=function(e,o){var i="string"==typeof o,u=this.method===n.POST,c=a.dictionaryNotEmpty(this.data),s=this.url;c&&!u&&(s=this.encodeData(s));var l=new XMLHttpRequest;l.open(this.method,s,!0),u&&l.setRequestHeader(r.CONTENT_TYPE,"application/x-www-form-urlencoded"),a.dictionaryForEach(this.headers,function(e,t){l.setRequestHeader(t,e)}),l.onreadystatechange=function(){4===l.readyState&&e(t(l))},l.onabort=function(){e(t())},i&&l.overrideMimeType(o),c&&u?l.send(this.encodeData()):l.send()},e}();e.Request=u}(c||(c={}));var s;!function(e){function t(e){var t=e.source.parentElement;u.reduce(u.cast(t.children),function(e,t){return t.hasAttribute("data-template-clone")&&e.push(t),e},[]).forEach(function(e){return t.removeChild(e)})}function n(e,t){return e.replace(t.regex,t.replacement)}function r(e){var t=[];return a.dictionaryForEach(e,function(e,n){c.test(n)?t.push({regex:new RegExp("%"+a.regexEscape(n)+"%","gi"),replacement:e}):console.error('Template arg key "'+n+'" is invalid: failed regex test '+c.source)}),t}function o(e,t){return t.reduce(function(e,t){return n(e,t)},e)}function i(e,t,n){var i=e.source.cloneNode(!0);i.style.display=e.display,i.setAttribute("data-template-clone","");var c=e.source.parentElement,s=r(t),l=null;return a.domIterate(i,{open:function(e){switch(e.nodeType){case Node.ELEMENT_NODE:var t=e;if(u.forEach(t.attributes,function(e){e.value=o(e.value,s)}),null===l&&t.hasAttribute("data-template")&&(l=e),null===l){if(t.hasAttribute("data-template-style")){var r=t.getAttribute("style");r=r||"",r+=t.getAttribute("data-template-style"),t.setAttribute("style",r),t.removeAttribute("data-template-style")}if(void 0!==n&&t.hasAttribute("data-template-callback")){var a=t.getAttribute("data-template-callback");t.removeAttribute("data-template-callback"),n(a,t,i,c)}}break;case Node.TEXT_NODE:e.textContent=o(e.textContent,s)}return!1},close:function(e){e===l&&(l=null)}},!0,Node.ELEMENT_NODE,Node.TEXT_NODE),c.appendChild(i),i}e.killTemplate=t;var c=/^[a-z0-9 \-_]+$/i;e.pushTemplate=i;var s=function(){function e(e,t){void 0===t&&(t=!1);var n;if(t&&e.hasAttribute("data-template"))n=[e];else{var r=e.querySelectorAll("[data-template]");n=u.filter(r,function(e){return!a.hasParentWithAttribute(e,"data-template")})}this.templates=n.reduce(function(e,t){var n=t.getAttribute("data-template");return e.hasOwnProperty(n)?console.error('Templater: Duplicate template ID "'+n+'".'):(t.removeAttribute("data-template"),e[n]={source:t,display:t.style.display},t.style.display="none"),e},{})}return e.prototype.getCount=function(){return this.getIds().length},e.prototype.getIds=function(){return Object.keys(this.templates)},e.prototype.getTemplate=function(e){return this.templates[e]},e.prototype.killTemplate=function(e){var n=this.getTemplate(e);void 0!==n&&t(n)},e.prototype.pushTemplate=function(e,t,n){var r,o=this.getTemplate(e);return void 0!==o&&(r=i(o,t,n)),r},e}();e.Templater=s}(s||(s={}));var l;!function(a){!function(t){function a(e,t,n){r(e.mutatorButtons,!0);var o=new c.Request(c.Method.GET,"http://localhost:8080");o.setData({json:JSON.stringify({action:null!==t?"removeCar":"addCar",id:t})}),o.execute(function(t){c.responseIsSuccess(t)?n.apply(void 0,arguments):0===t.status?alert("Error: JADE was not activated, or the provided port number was incorrect."):alert("Error: "+JSON.parse(t.text).error),r(e.mutatorButtons,!1)})}function u(e,t,n,r){e.jsonData[r]=e.defaultJson,e.currentCid=r,d(e,t,n),s.pushTemplate(e.cidTemplate,{CID:r},function(o,i,u,c){"remove-btn"===o?i.addEventListener("click",function(){a(e,r,function(o){var a=JSON.parse(o.text);if(a.hasOwnProperty("error"))alert(a.error);else{if(delete e.jsonData[r],e.currentCid===r){var i=Object.keys(e.jsonData);e.currentCid=i.length>0?i[0]:null,d(e,t,n)}c.removeChild(u)}})}):"switch-car"===o&&i.addEventListener("change",function(){e.currentCid=r,d(e,t,n)})})}function l(e,t,n){void 0!==e?(t.value=(Math.round(100*e)/100).toString(),n.checked=!1):(t.value="",n.checked=!0),t.disabled=n.checked}function d(t,r,o){if(n(o,t),t.inputJson.checked)t.formJson.style.display="",t.formFields.style.display="none";else{t.formJson.style.display="none",t.formFields.style.display="";var a=e(o);l(a.maxGridLoad,r.gridLoad,r.gridLoadNoChange),l(a.currentCharge,r.currentCharge,r.currentChargeNoChange),l(a.chargeCapacity,r.maxCharge,r.maxChargeNoChange),l(a.chargePerHour,r.chargeRate,r.chargeRateNoChange),l(a.chargeDrainPerHour,r.chargeDrain,r.chargeDrainNoChange),s.killTemplate(r.utTemplate);var u=void 0===a.unavailableTimes;u||a.unavailableTimes.forEach(function(e){return i.pushUtTemplate(r.utTemplate,e,o,t)}),r.utNoChange.checked=u,r.utLowValue.disabled=u,r.utLowInclusive.disabled=u,r.utHighValue.disabled=u,r.utHighInclusive.disabled=u,r.utAddButton.disabled=u,r.utAddButton.disabled=u}}t.getPort=function(e){return null!==e.currentCid?parseInt(e.currentCid):-1},t.validatePort=function(e){var t=void 0;return isNaN(e)?t="Car ID is not a number.":e%1!=0?t="Car ID must be an integer.":-1===e?t='You must choose a car to update. If no cars exist, press the "Add New Car" button.':(e<8080||e>28080)&&(t="Car ID must be between 8080 and 28080, inclusive."),t},t.addCar=u,t.setupListeners=function(e,t,n,r){e.inputJson.addEventListener("change",function(){return d(e,t,n)}),e.inputFields.addEventListener("change",function(){return d(e,t,n)}),e.addCarButton.addEventListener("click",function(){a(e,null,function(r){u(e,t,n,r.text)})}),o(e,e.form,n,"constraints",r)},t.switchDisplayedForm=d}(a.Global||(a.Global={})),(a.Json||(a.Json={})).setupListeners=function(e,t,n,r){n.addEventListener("change",function(){null!==e.currentCid&&(e.jsonData[e.currentCid]=n.value)}),o(e,t.form,n,"constraints",r)};var i;!function(n){function r(e,t){var n=parseFloat(e.value);isNaN(n)||!isFinite(n)?console.error(e.id+" not a number."):t(n)}function a(n,o,a,i){r(n,function(n){var r=e(a);r[o]=n,t(a,r,i)})}function i(n,r,o,i,u){n.addEventListener("change",function(){o.checked||a(n,r,i,u)}),o.addEventListener("change",function(){if(n.disabled=o.checked,o.checked){var c=e(i);delete c[r],t(i,c,u)}else a(n,r,i,u)})}function u(e){var t=e.toString();return 1===t.length&&(t="0"+t),t+":00"}function c(e,t){var n=-1;return e.some(function(e,r){var o=e.lowerBound.value===t.lowerBound.value&&e.lowerBound.inclusive==t.lowerBound.inclusive&&e.upperBound.value===t.upperBound.value&&e.upperBound.inclusive===t.upperBound.inclusive;return o&&(n=r),o}),n}function l(n,r,o,a){s.pushTemplate(n,{LOW:r.lowerBound.value,LOW_BRACKET:r.lowerBound.inclusive?"[":"(",HIGH:r.upperBound.value,HIGH_BRACKET:r.upperBound.inclusive?"]":")"},function(n,i,u,s){"remove-btn"===n&&i.addEventListener("click",function(){var n=e(o),i=n.unavailableTimes;i.splice(c(i,r),1),t(o,n,a),s.removeChild(u)})})}function d(n,r,o){n.utLowValue.disabled=n.utNoChange.checked,n.utLowInclusive.disabled=n.utNoChange.checked,n.utHighValue.disabled=n.utNoChange.checked,n.utHighInclusive.disabled=n.utNoChange.checked,n.utAddButton.disabled=n.utNoChange.checked;var a=e(r);n.utNoChange.checked?(s.killTemplate(n.utTemplate),delete a.unavailableTimes,t(r,a,o)):(a.unavailableTimes=[],t(r,a,o))}n.pushUtTemplate=l,n.setupListeners=function(n,a,c,s){i(a.gridLoad,"maxGridLoad",a.gridLoadNoChange,c,n),i(a.currentCharge,"currentCharge",a.currentChargeNoChange,c,n),i(a.maxCharge,"chargeCapacity",a.maxChargeNoChange,c,n),i(a.chargeRate,"chargePerHour",a.chargeRateNoChange,c,n),i(a.chargeDrain,"chargeDrainPerHour",a.chargeDrainNoChange,c,n),a.utNoChange.addEventListener("change",function(){return d(a,c,n)}),a.utAddButton.addEventListener("click",function(){a.utNoChange.checked?alert("Error: Cannot add an unavailable time range when the Do Not Change checkbox is checked."):r(a.utLowValue,function(o){return r(a.utHighValue,function(r){var i={lowerBound:{value:u(o),inclusive:a.utLowInclusive.checked},upperBound:{value:u(r),inclusive:a.utHighInclusive.checked}},s=e(c);s.unavailableTimes.push(i),t(c,s,n),l(a.utTemplate,i,c,n)})})}),o(n,a.form,c,"constraints",s)}}(i=a.Fields||(a.Fields={}))}(l||(l={}));var d;!function(e){function t(e){return e.hasOwnProperty("error")}function n(e){e.switchModeVis.checked?(e.visSection.style.display=null,e.raw.style.display="none"):(e.visSection.style.display="none",e.raw.style.display=null)}e.renderResponse=function(e,n,r,o){s.killTemplate(e.timetableTemplate);var i=JSON.parse(o);if(e.raw.textContent=a.formatJson(i),e.car.textContent=n.toString(),e.status.textContent=r.toString(),t(i))e.errorHead.style.display=null,e.error.style.display=null,e.timetableContainer.style.display="none",e.error.textContent=i.error;else{e.errorHead.style.display="none",e.error.style.display="none",e.timetableContainer.style.display=null;var c={},l={};console.log(i),i.result.forEach(function(t){var n=t.id.toString();if(l.hasOwnProperty(n)?l[n]=u.concat(l[n],t.slots):l[n]=t.slots,!c.hasOwnProperty(n)){var r=s.pushTemplate(e.timetableTemplate,{CAR:n});c[n]=new s.Templater(r)}});var d;a.dictionaryForEach(c,function(t,n){d=l[n];for(var r=0;r<e.timetableSize;r++)t.pushTemplate(e.timetableSubTemplateId,{CLASS:d.indexOf(r)>=0?"tt-range":""})})}e.inContainer.style.display="none",e.outContainer.style.display=null},e.setupListeners=function(e){e.inContainer.style.display=null,e.outContainer.style.display="none",a.asyncFormSubmit(e.switchForm),e.switchModeVis.addEventListener("change",function(){return n(e)}),e.switchModeRaw.addEventListener("change",function(){return n(e)}),n(e),e.backBtn.addEventListener("click",function(){e.inContainer.style.display=null,e.outContainer.style.display="none"})}}(d||(d={})),window.addEventListener("DOMContentLoaded",function(){for(var e=new s.Templater(document.body),t={form:document.getElementById("form-json"),text:document.getElementById("input-json")},n={form:document.getElementById("form-fields"),gridLoad:document.getElementById("input-grid-load"),gridLoadNoChange:document.getElementById("input-grid-load-nc"),currentCharge:document.getElementById("input-current-charge"),currentChargeNoChange:document.getElementById("input-current-charge-nc"),maxCharge:document.getElementById("input-charge-capacity"),maxChargeNoChange:document.getElementById("input-charge-capacity-nc"),chargeRate:document.getElementById("input-charge-rate"),chargeRateNoChange:document.getElementById("input-charge-rate-nc"),chargeDrain:document.getElementById("input-charge-drain"),chargeDrainNoChange:document.getElementById("input-charge-drain-nc"),utLowValue:document.getElementById("input-ut-low"),utLowInclusive:document.getElementById("input-ut-low-inc"),utHighValue:document.getElementById("input-ut-high"),utHighInclusive:document.getElementById("input-ut-high-inc"),utAddButton:document.getElementById("input-ut-add"),utNoChange:document.getElementById("input-ut-nc"),utTemplate:e.getTemplate("ut")},a={form:document.getElementById("form-global"),inputJson:document.getElementById("mode-json"),inputFields:document.getElementById("mode-fields"),formJson:t.form,formFields:n.form,carsContainer:document.getElementById("cars"),addCarButton:document.getElementById("add-car-btn"),mutatorButtons:[document.getElementById("json-submit"),document.getElementById("fields-submit"),document.getElementById("force-submit"),n.utAddButton,function(){return document.getElementsByTagName("button")}],jsonData:{},defaultJson:JSON.parse(t.text.value),currentCid:null,cidTemplate:e.getTemplate("cid")},i=document.getElementById("form-force"),u={inContainer:document.getElementById("sec-input"),outContainer:document.getElementById("sec-output"),visSection:document.getElementById("out-vis-sec"),switchForm:document.getElementById("out-switch"),switchModeVis:document.getElementById("out-vis"),switchModeRaw:document.getElementById("out-raw"),backBtn:document.getElementById("return-to-input"),raw:document.getElementById("out-var-raw"),car:document.getElementById("out-var-car"),status:document.getElementById("out-var-status"),errorHead:document.getElementById("out-var-error-head"),error:document.getElementById("out-var-error"),timetableContainer:document.getElementById("out-var-tt"),timetableTemplate:e.getTemplate("tt-data-wrap"),timetableSubTemplateId:"tt-data-hours",timetableSize:24},p=0;p<u.timetableSize;p++)e.pushTemplate("tt-hours",{N:p.toString()});l.Global.setupListeners(a,n,t.text,u),l.Json.setupListeners(a,t,t.text,u),l.Fields.setupListeners(a,n,t.text,u),o(a,i,t.text,"negotiate",u),l.Global.switchDisplayedForm(a,n,t.text),d.setupListeners(u),r(a.mutatorButtons,!0);var h=new c.Request(c.Method.GET,"http://localhost:8080/");h.setData({json:JSON.stringify({action:"getCars"})});var m="UI layer is unusable if JADE is not activated. Please start JADE and refresh this page.";h.execute(function(e){c.responseIsSuccess(e)?(JSON.parse(e.text).forEach(function(e){return l.Global.addCar(a,n,t.text,e)}),r(a.mutatorButtons,!1)):0===e.status?alert(m):alert(m+"\nError: "+e.text)})});